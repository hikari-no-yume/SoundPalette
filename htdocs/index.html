<!doctype html>
<meta charset=utf-8>
<title>SoundPalette</title>
<!-- Part of SoundPalette by hikari_no_yume.
   -
   - This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at https://mozilla.org/MPL/2.0/. -->
<style>
* {
    /* padding and width:100% interact weirdly without this */
    box-sizing: border-box;
}
body {
    font-family: sans-serif;
}
h1 {
    margin: 0 0 0;
    font-weight: normal;
    font-style: italic;
    font-family: "MS PGothic", sans-serif;
    display: inline-block;
}
h1 > span:nth-child(1) {
    font-size: 1.5ex;
    text-transform: uppercase;
    color: chartreuse;
}
h1 > span:nth-child(2) {
    font-weight: bold;
    color: darkorange;
}
h1 > span:nth-child(3) {
    display: block;
    font-size: 40%;
    text-align: right;
    text-transform: uppercase;
}
#disclaimer {
    color: grey;
}
textarea {
    width: 100%;
}
table, th, td {
    border: 1px solid gray;
    border-collapse: collapse;
}
th, td {
    vertical-align: top;
    text-align: left;
    font-family: monospace;
    padding: 0.25em;
}
#table-zone > table, #sketchpad-collection-table-zone > table {
    width: 100%;
}
/* Show at most eight bytes per row for the raw event bytes column. */
#table-zone > table th:nth-child(2), #table-zone > table td:nth-child(2) {
    width: 32ch;
}
/* Try to match styling between button labels and other labels. */
button, label, .note {
    font-size: smaller;
    font-family: -apple-system, sans-serif;
}
/* Prevent dropdowns from wrapping to a point left of the right edge of the
 * “Generator SysEx:” label, and prevent them from shrinking the label.
 */
#sketchpad-generator {
    display: flex;
}
#sketchpad-generator > label {
    margin-right: 0.5em;
    padding-top: 0.1em;
    flex-shrink: 0;
}
/* Put the SysEx collection to the right of the main part of the sketchpad,
 * unless the window is relatively narrow.
 */
@media (min-width: 950px) {
    #sketchpad {
        display: flex;
        gap: 1em;
    }
    #sketchpad-main-group {
        min-width: 510px;
        width: 50%;
        flex-shrink: 0;
    }
    #sketchpad-collection {
        min-width: 400px;
        width: 100%;
    }
}
@media (max-width: 950px) {
    #sketchpad-collection {
        margin-top: 1em;
    }
}
/* Put the log to the right of the sound test area if the window is quite wide.
 */
@media (min-width: 1200px) {
    #webmidi-test-sent-data-group {
        display: flex;
    }
    #webmidi-test {
        flex-shrink: 0;
        max-width: 900px;
    }
    #webmidi-sent-data {
        height: 100%;
    }
}
</style>

<h1><span>Sound</span><span>Palette</span> <span>MIDI SysEx Generator</span></h1>
<p id=disclaimer>※ SoundPalette is not a product of, affiliated with or endorsed by Roland Corporation.</p>

<noscript>SoundPalette is a SysEx editing tool. This is a web app that relies on WebAssembly and JavaScript. You appear to have these disabled, so you won't be able to use it.</noscript>

<fieldset>
<legend>Inspect Standard MIDI File</legend>
<input type=file id=file accept=audio/midi disabled autocomplete=off>
<br>
<textarea id=log disabled cols=80 rows=5 autocomplete=off>
This app is System Exclusive Parameter Editor.
Instruments do their best now and are preparing. Please watch warmly until it is ready.
The MIDI land was wrapped in Synthesis Magic. Girls believe that you solve this mystery…
</textarea>
<div id=table-zone></div>
</fieldset>

<br>

<fieldset>
<legend>Connect to MIDI device (Web MIDI)</legend>
<button id=webmidi-enable disabled>Enable Web MIDI</button> <span class=note>(Note: as of 2023-11, this is unreliable in Firefox, but works very well in Chrome.)</span><br><br>
<select id=webmidi-devices disabled><option>(please enable Web MIDI)</option></select>
<button id=webmidi-device-connect disabled>Connect</button><br><br>

<div id=webmidi-test-sent-data-group>
<fieldset id=webmidi-test disabled>
<legend>Sound test</legend>
<select id=webmidi-channel><option>(please wait)</option></select>
<br><br>
<select id=webmidi-pc>
<option value=0>00h — #1 [GM: Acoustic Grand Piano]</option>
<option value=1>01h — #2 [GM: Bright Acoustic Piano]</option>
<option value=2>02h — #3 [GM: Electric Grand Piano]</option>
<option value=3>03h — #4 [GM: Honky-tonk Piano]</option>
<option value=4>04h — #5 [GM: Electric Piano 1]</option>
<option value=5>05h — #6 [GM: Electric Piano 2]</option>
<option value=6>06h — #7 [GM: Harpsichord]</option>
<option value=7>07h — #8 [GM: Clavi]</option>
<option value=8>08h — #9 [GM: Celesta]</option>
<option value=9>09h — #10 [GM: Glockenspiel]</option>
<option value=10>0Ah — #11 [GM: Music Box]</option>
<option value=11>0Bh — #12 [GM: Vibraphone]</option>
<option value=12>0Ch — #13 [GM: Marimba]</option>
<option value=13>0Dh — #14 [GM: Xylophone]</option>
<option value=14>0Eh — #15 [GM: Tubular Bells]</option>
<option value=15>0Fh — #16 [GM: Dulcimer]</option>
<option value=16>10h — #17 [GM: Drawbar Organ]</option>
<option value=17>11h — #18 [GM: Percussive Organ]</option>
<option value=18>12h — #19 [GM: Rock Organ]</option>
<option value=19>13h — #20 [GM: Church Organ]</option>
<option value=20>14h — #21 [GM: Reed Organ]</option>
<option value=21>15h — #22 [GM: Accordion]</option>
<option value=22>16h — #23 [GM: Harmonica]</option>
<option value=23>17h — #24 [GM: Tango Accordion]</option>
<option value=24>18h — #25 [GM: Acoustic Guitar (nylon)]</option>
<option value=25>19h — #26 [GM: Acoustic Guitar (steel)]</option>
<option value=26>1Ah — #27 [GM: Electric Guitar (jazz)]</option>
<option value=27>1Bh — #28 [GM: Electric Guitar (clean)]</option>
<option value=28>1Ch — #29 [GM: Electric Guitar (muted)]</option>
<option value=29>1Dh — #30 [GM: Overdriven Guitar]</option>
<option value=30>1Eh — #31 [GM: Distortion Guitar]</option>
<option value=31>1Fh — #32 [GM: Guitar harmonics]</option>
<option value=32>20h — #33 [GM: Acoustic Bass]</option>
<option value=33>21h — #34 [GM: Electric Bass (finger)]</option>
<option value=34>22h — #35 [GM: Electric Bass (pick)]</option>
<option value=35>23h — #36 [GM: Fretless Bass]</option>
<option value=36>24h — #37 [GM: Slap Bass 1]</option>
<option value=37>25h — #38 [GM: Slap Bass 2]</option>
<option value=38>26h — #39 [GM: Synth Bass 1]</option>
<option value=39>27h — #40 [GM: Synth Bass 2]</option>
<option value=40>28h — #41 [GM: Violin]</option>
<option value=41>29h — #42 [GM: Viola]</option>
<option value=42>2Ah — #43 [GM: Cello]</option>
<option value=43>2Bh — #44 [GM: Contrabass]</option>
<option value=44>2Ch — #45 [GM: Tremolo Strings]</option>
<option value=45>2Dh — #46 [GM: Pizzicato Strings]</option>
<option value=46>2Eh — #47 [GM: Orchestral Harp]</option>
<option value=47>2Fh — #48 [GM: Timpani]</option>
<option value=48>30h — #49 [GM: String Ensemble 1]</option>
<option value=49>31h — #50 [GM: String Ensemble 2]</option>
<option value=50>32h — #51 [GM: SynthStrings 1]</option>
<option value=51>33h — #52 [GM: SynthStrings 2]</option>
<option value=52>34h — #53 [GM: Choir Aahs]</option>
<option value=53>35h — #54 [GM: Voice Oohs]</option>
<option value=54>36h — #55 [GM: Synth Voice]</option>
<option value=55>37h — #56 [GM: Orchestra Hit]</option>
<option value=56>38h — #57 [GM: Trumpet]</option>
<option value=57>39h — #58 [GM: Trombone]</option>
<option value=58>3Ah — #59 [GM: Tuba]</option>
<option value=59>3Bh — #60 [GM: Muted Trumpet]</option>
<option value=60>3Ch — #61 [GM: French Horn]</option>
<option value=61>3Dh — #62 [GM: Brass Section]</option>
<option value=62>3Eh — #63 [GM: SynthBrass 1]</option>
<option value=63>3Fh — #64 [GM: SynthBrass 2]</option>
<option value=64>40h — #65 [GM: Soprano Sax]</option>
<option value=65>41h — #66 [GM: Alto Sax]</option>
<option value=66>42h — #67 [GM: Tenor Sax]</option>
<option value=67>43h — #68 [GM: Baritone Sax]</option>
<option value=68>44h — #69 [GM: Oboe]</option>
<option value=69>45h — #70 [GM: English Horn]</option>
<option value=70>46h — #71 [GM: Bassoon]</option>
<option value=71>47h — #72 [GM: Clarinet]</option>
<option value=72>48h — #73 [GM: Piccolo]</option>
<option value=73>49h — #74 [GM: Flute]</option>
<option value=74>4Ah — #75 [GM: Recorder]</option>
<option value=75>4Bh — #76 [GM: Pan Flute]</option>
<option value=76>4Ch — #77 [GM: Blown Bottle]</option>
<option value=77>4Dh — #78 [GM: Shakuhachi]</option>
<option value=78>4Eh — #79 [GM: Whistle]</option>
<option value=79>4Fh — #80 [GM: Ocarina]</option>
<option value=80>50h — #81 [GM: Lead 1 (square)]</option>
<option value=81>51h — #82 [GM: Lead 2 (sawtooth)]</option>
<option value=82>52h — #83 [GM: Lead 3 (calliope)]</option>
<option value=83>53h — #84 [GM: Lead 4 (chiff)]</option>
<option value=84>54h — #85 [GM: Lead 5 (charang)]</option>
<option value=85>55h — #86 [GM: Lead 6 (voice)]</option>
<option value=86>56h — #87 [GM: Lead 7 (fifths)]</option>
<option value=87>57h — #88 [GM: Lead 8 (bass + lead)]</option>
<option value=88>58h — #89 [GM: Pad 1 (new age)]</option>
<option value=89>59h — #90 [GM: Pad 2 (warm)]</option>
<option value=90>5Ah — #91 [GM: Pad 3 (polysynth)]</option>
<option value=91>5Bh — #92 [GM: Pad 4 (choir)]</option>
<option value=92>5Ch — #93 [GM: Pad 5 (bowed)]</option>
<option value=93>5Dh — #94 [GM: Pad 6 (metallic)]</option>
<option value=94>5Eh — #95 [GM: Pad 7 (halo)]</option>
<option value=95>5Fh — #96 [GM: Pad 8 (sweep)]</option>
<option value=96>60h — #97 [GM: FX 1 (rain)]</option>
<option value=97>61h — #98 [GM: FX 2 (soundtrack)]</option>
<option value=98>62h — #99 [GM: FX 3 (crystal)]</option>
<option value=99>63h — #100 [GM: FX 4 (atmosphere)]</option>
<option value=100>64h — #101 [GM: FX 5 (brightness)]</option>
<option value=101>65h — #102 [GM: FX 6 (goblins)]</option>
<option value=102>66h — #103 [GM: FX 7 (echoes)]</option>
<option value=103>67h — #104 [GM: FX 8 (sci-fi)]</option>
<option value=104>68h — #105 [GM: Sitar]</option>
<option value=105>69h — #106 [GM: Banjo]</option>
<option value=106>6Ah — #107 [GM: Shamisen]</option>
<option value=107>6Bh — #108 [GM: Koto]</option>
<option value=108>6Ch — #109 [GM: Kalimba]</option>
<option value=109>6Dh — #110 [GM: Bag pipe]</option>
<option value=110>6Eh — #111 [GM: Fiddle]</option>
<option value=111>6Fh — #112 [GM: Shanai]</option>
<option value=112>70h — #113 [GM: Tinkle Bell]</option>
<option value=113>71h — #114 [GM: Agogo]</option>
<option value=114>72h — #115 [GM: Steel Drums]</option>
<option value=115>73h — #116 [GM: Woodblock]</option>
<option value=116>74h — #117 [GM: Taiko Drum]</option>
<option value=117>75h — #118 [GM: Melodic Tom]</option>
<option value=118>76h — #119 [GM: Synth Drum]</option>
<option value=119>77h — #120 [GM: Reverse Cymbal]</option>
<option value=120>78h — #121 [GM: Guitar Fret Noise]</option>
<option value=121>79h — #122 [GM: Breath Noise]</option>
<option value=122>7Ah — #123 [GM: Seashore]</option>
<option value=123>7Bh — #124 [GM: Bird Tweet]</option>
<option value=124>7Ch — #125 [GM: Telephone Ring]</option>
<option value=125>7Dh — #126 [GM: Helicopter]</option>
<option value=126>7Eh — #127 [GM: Applause]</option>
<option value=127>7Fh — #128 [GM: Gunshot]</option>
</select>
<button id=webmidi-send-pc>Send Program Change</button>
<br>
<br>
<select id=webmidi-cc>
<option value=-1>(Channel Pressure)</option>
<option value=1>01h = 1 — Modulation</option>
<option value=7>07h = 7 — Channel Volume</option>
<option value=10>0Ah = 10 — Pan</option>
<option value=11>0Bh = 11 — Expression</option>
<option value=64>40h = 64 — Sustain</option>
<option value=91>5Bh = 91 — Effects 1 Depth [GS: Reverb]</option>
<option value=93>5Dh = 93 — Effects 3 Depth [GS: Chorus]</option>
</select>
<select id=webmidi-cc-value-0><option>(please wait)</option></select>
<button id=webmidi-send-cc-0>Set</button>
<button id=webmidi-sweep-cc-0-to-1>Sweep → (5s)</button>
<button id=webmidi-sweep-cc-1-to-0>Sweep ← (5s)</button>
<select id=webmidi-cc-value-1><option>(please wait)</option></select>
<button id=webmidi-send-cc-1>Set</button>
<br>
<br>
<select id=webmidi-note><option>(please wait)</option></select>
<select id=webmidi-velocity><option>(please wait)</option></select>
<select id=webmidi-duration><option>(please wait)</option></select>
<select id=webmidi-chord>
<option value=0>Single note</option>
<option value=0-4-7>Major triad</option>
<option value=0-3-7>Minor triad</option>
<option value=0-4-7-11>Major seventh chord</option>
<option value=0-3-7-10>Minor seventh chord</option>
<option value=0-7>Power chord</option>
</select>
<button id=webmidi-play-note>Play</button>
<button id=webmidi-repeat-note>Repeat</button>
</fieldset>

<br>

<fieldset>
<legend>Control data log <button id=webmidi-sent-data-clear disabled>Clear</button></legend>
<textarea id=webmidi-sent-data disabled cols=80 rows=5></textarea>
</fieldset>
</div>

</fieldset>

<br>

<fieldset id=sketchpad>
<legend>SysEx sketchpad</legend>
<div id=sketchpad-main-group>
<div id=sketchpad-generator>
<label for=sketchpad-generator-root-dropdown>↓ Generate SysEx:</label>
<div id=sketchpad-generator-dropdowns>
<select id=sketchpad-generator-root-dropdown required disabled>
<option value="">(please wait)</option>
</select><!-- avoid extra space between dropdowns --></div>
</div>
<textarea type=text id=sketchpad-input disabled cols=80 rows=5 autocomplete=off></textarea>
<br>
<button id=sketchpad-check disabled>↓ Check</button>
<button id=sketchpad-copy disabled>Copy</button>
<button id=sketchpad-copy-no-suffix disabled>Copy (no h suffix)</button>
<button id=sketchpad-send disabled>Send to MIDI device</button>
<button id=sketchpad-collect disabled>→ Collect</button>
<br>
<textarea id=sketchpad-log disabled cols=80 rows=5 autocomplete=off>
This app is System Exclusive Parameter Editor.
Instruments do their best now and are preparing. Please watch warmly until it is ready.
The MIDI land was wrapped in Synthesis Magic. Girls believe that you solve this mystery…
</textarea>
</div>

<fieldset id=sketchpad-collection>
<legend>SysEx collection</legend>
<button id=sketchpad-collection-export disabled>Export to Standard MIDI File</button>
<button id=sketchpad-collection-clear disabled>Clear</button>
<br><br>
<div id=sketchpad-collection-table-zone></div>
</fieldset>
</fieldset>

<script>
(function () {
    'use strict';

    window.onload = function () {
        WebAssembly.instantiateStreaming(fetch('libSoundPalette.wasm'), {}).then(main);
    };

    let instance, lib, mem;

    function memcpy(destBuf, destPtr, srcBuf, srcPtr, size) {
        (new Uint8Array(destBuf, destPtr, size)).set(new Uint8Array(srcBuf, srcPtr, size))
    }

    function decodeAndClearString(stringPtr) {
        let bytesPtr = lib.SoundPalette_string_ptr(stringPtr);
        let bytesLen = lib.SoundPalette_string_len(stringPtr);

        let decoded = (new TextDecoder).decode(new Uint8Array(mem.buffer, bytesPtr, bytesLen));

        lib.SoundPalette_string_clear(stringPtr);

        return decoded;
    }

    function encodeStringAndCreateBytes(string) {
        let bytes = (new TextEncoder).encode(string);
        let bytesPtr = lib.SoundPalette_bytes_new(bytes.length);
        memcpy(mem.buffer, bytesPtr, bytes, 0, bytes.length);
        return {
            bytesPtr: bytesPtr,
            bytesLen: bytes.length, // needed for freeing
        };
    }

    // Parses the NullTerminatedStringTableStream format.
    function tabulate(string) {
        let pieces = string.split('\0');

        let table = document.createElement('table');
        let isHeaderRow = true;
        let tr = null;
        for (let i = 0; i < pieces.length; i++) {
            let piece = pieces[i];

            if (piece === '') {
                // '\0' is a terminator but String.prototype.split treats it as
                // a separator, so there's a phantom row at the end.
                if (tr === null && i === pieces.length - 1) {
                    break;
                }

                table.appendChild(tr);
                tr = null;
                isHeaderRow = false;
                continue;
            }

            if (tr === null) {
                tr = document.createElement('tr');
            }

            let td = document.createElement(isHeaderRow ? 'th' : 'td');
            td.textContent = piece;
            tr.appendChild(td);
        }

        if (tr !== null) {
            table.appendChild(tr);
        }

        return table;
    }

    function main(result) {
        instance = result.instance;
        lib = instance.exports;
        mem = instance.exports.memory;

        let fileInput = document.getElementById('file');
        fileInput.disabled = false;
        fileInput.value = ''; // clear any cached value
        let logTextarea = document.getElementById('log');
        logTextarea.textContent = 'SoundPalette system ready. Please load a file.';

        let tableZone = document.getElementById('table-zone');

        let stringPtr = lib.SoundPalette_string_new(0);

        fileInput.onchange = () => {
            fileInput.files[0].arrayBuffer().then((buffer) => {
                let bufferU8 = new Uint8Array(buffer);

                let destBytesLen = bufferU8.length;
                let destBytesPtr = lib.SoundPalette_bytes_new(destBytesLen);
                memcpy(mem.buffer, destBytesPtr, buffer, 0, destBytesLen);
                let midiDataPtr = lib.SoundPalette_read_midi_and_log(stringPtr, destBytesPtr, destBytesLen);
                lib.SoundPalette_bytes_free(destBytesPtr, destBytesLen);

                logTextarea.textContent = decodeAndClearString(stringPtr);

                if (midiDataPtr === 0) {
                    return;
                }

                lib.SoundPalette_midi_data_list_other_events(stringPtr, midiDataPtr, /* with_time_and_kind: */ true);

                tableZone.innerHTML = '';
                tableZone.appendChild(tabulate(decodeAndClearString(stringPtr)));

                lib.SoundPalette_midi_data_free(midiDataPtr);
            });
        };

        let sketchpadInputTextarea = document.getElementById('sketchpad-input');
        sketchpadInputTextarea.disabled = false;
        let sketchpadLogTextarea = document.getElementById('sketchpad-log');
        sketchpadLogTextarea.textContent = 'SoundPalette system ready. Please enter a SysEx.';

        let sketchpadCheckButton = document.getElementById('sketchpad-check');
        sketchpadCheckButton.disabled = false;
        sketchpadCheckButton.onclick = () => {
            let inputBytes = encodeStringAndCreateBytes(sketchpadInputTextarea.value);
            lib.SoundPalette_check_sysex(stringPtr, inputBytes.bytesPtr, inputBytes.bytesLen);
            lib.SoundPalette_bytes_free(inputBytes.bytesPtr, inputBytes.bytesLen);

            sketchpadLogTextarea.textContent = decodeAndClearString(stringPtr);
        };

        function doCopy() {
            sketchpadInputTextarea.select();
            // I don't trust this fancy new tech!
            if (navigator.clipboard) {
                navigator.clipboard.writeText(sketchpadInputTextarea.value);
            } else {
                document.execCommand('copy');
            }
        }

        let sketchpadCopyButton = document.getElementById('sketchpad-copy');
        sketchpadCopyButton.disabled = false;
        sketchpadCopyButton.onclick = () => {
            doCopy();
        };

        function getSketchpadBytes(asBytes) {
            // This should be kept in sync with the Rust sysex parsing.
            // TODO: Replace with a call to Rust.
            let unsuffixed = sketchpadInputTextarea
                .value
                .trim()
                .split(/\s+/)
                .map(hex =>
                    ((hex.endsWith('h') || hex.endsWith('H'))
                    ? hex.substring(0, hex.length - 1)
                    : hex));
            for (let i = 0; i < unsuffixed.length; i++) {
                if (!/^[0-9a-fA-F]{2}$/.test(unsuffixed[i])) {
                    alert('Error: "' + unsuffixed[i] + '" is not recognised as a hex byte');
                    return null;
                }
            }
            if (unsuffixed.length < 2 ||
                unsuffixed[0].toUpperCase() !== 'F0' ||
                unsuffixed[unsuffixed.length - 1].toUpperCase() !== 'F7') {
                alert('Error: not a complete sysex, needs to start with F0h and end with F7h');
                return null;
            }
            if (asBytes) {
                let arr = new Uint8Array(unsuffixed.length);
                for (let i = 0; i < unsuffixed.length; i++) {
                    let byte = parseInt(unsuffixed[i], 16);
                    if (i !== 0 && i !== unsuffixed.length - 1 && byte > 0x7F) {
                        alert('Error: contains invalid data bytes, out of range (> 7Fh)');
                        return null;
                    }
                    arr[i] = byte;
                }
                return arr;
            } else {
                return unsuffixed.join(' ');
            }
        }

        let sketchpadCopyNoSuffixButton = document.getElementById('sketchpad-copy-no-suffix');
        sketchpadCopyNoSuffixButton.disabled = false;
        sketchpadCopyNoSuffixButton.onclick = () => {
            // This should be kept in sync with the Rust sysex parsing.
            let unsuffixed = getSketchpadBytes(false);
            if (unsuffixed === null) {
                return;
            }
            sketchpadInputTextarea.value = unsuffixed;
            doCopy();
        };

        let sketchpadSendButton = document.getElementById('sketchpad-send');
        sketchpadSendButton.disabled = true;
        // onclick handler is with Web MIDI stuff below

        let sketchpadCollectButton = document.getElementById('sketchpad-collect');
        sketchpadCollectButton.disabled = false;
        // onclick handler is with collection stuff below

        let sketchpadGeneratorDropdownsZone = document.getElementById('sketchpad-generator-dropdowns');

        let menuStackDropdowns = [document.getElementById('sketchpad-generator-root-dropdown')];
        let menuStackPtr = lib.SoundPalette_sysex_generator_menu_stack_new();

        function menuStackUpdateCurrentList() {
            lib.SoundPalette_sysex_generator_menu_stack_list_items(stringPtr, menuStackPtr);
            let menuItems = decodeAndClearString(stringPtr).split('\0');
            if (menuItems[0] === '' && menuItems.length === 1) { // empty menu
                menuItems = [];
            }

            let menuStackDropdown = menuStackDropdowns[menuStackDropdowns.length - 1];
            menuStackDropdown.innerHTML = '';
            let unselectedOption = document.createElement('option');
            unselectedOption.textContent = '(please select)';
            unselectedOption.value = '';
            menuStackDropdown.appendChild(unselectedOption);
            let stackHeightForDropdown = menuStackDropdowns.length;
            menuItems.forEach((item, itemIdx) => {
                let option = document.createElement('option');
                if (item.startsWith('\x18')) {
                    option.textContent = item.substring(1);
                    option.disabled = true;
                } else {
                    option.textContent = item;
                }
                option.value = itemIdx;
                menuStackDropdown.appendChild(option);
            });
            menuStackDropdown.onchange = () => {
                let selectedIdx = menuStackDropdown.value;
                if (selectedIdx === '') {
                    menuStackPush(stackHeightForDropdown, null);
                } else {
                    menuStackPush(stackHeightForDropdown, +selectedIdx);
                }
            };
            menuStackDropdown.disabled = false;
        }

        function menuStackPush(stackHeightForDropdown, itemIdx) {
            console.log('Push at: ' + stackHeightForDropdown);

            // Only the top item of the stack can be manipulated at once.
            // If the menu that the selection was made in is not the top one,
            // the menus above it need to be popped.
            while (stackHeightForDropdown < menuStackDropdowns.length) {
                console.log('- Popping: ' + menuStackDropdowns.length);
                lib.SoundPalette_sysex_generator_menu_stack_pop(menuStackPtr);

                let oldDropdown = menuStackDropdowns.pop();
                oldDropdown.parentElement.removeChild(oldDropdown);
            }

            if (itemIdx === null) {
                console.log('- No descent.');
                return;
            }

            console.log('- Descending: ' + itemIdx);
            let didGenerateSysEx = lib.SoundPalette_sysex_generator_menu_stack_push(stringPtr, menuStackPtr, itemIdx);
            if (didGenerateSysEx) {
                console.log('- SysEx generated.');
                sketchpadInputTextarea.value = decodeAndClearString(stringPtr);
            } else {
                console.log('- New submenu.');
                let newDropdown = document.createElement('select');
                newDropdown.required = true;
                newDropdown.disabled = true;
                sketchpadGeneratorDropdownsZone.appendChild(newDropdown);
                menuStackDropdowns.push(newDropdown);

                menuStackUpdateCurrentList();

                newDropdown.focus();
            }
        }

        menuStackUpdateCurrentList();

        // For now this is never freed, since the menu stack is always in use.
        //lib.SoundPalette_sysex_generator_menu_stack_free(menuStackPtr);

        let sketchpadCollectionMidiDataPtr = lib.SoundPalette_midi_data_new();

        let sketchpadCollectionTableZone = document.getElementById('sketchpad-collection-table-zone');

        function refreshCollectionTable() {
            lib.SoundPalette_midi_data_list_other_events(stringPtr, sketchpadCollectionMidiDataPtr, /* with_time_and_kind: */ false);
            sketchpadCollectionTableZone.innerHTML = '';
            sketchpadCollectionTableZone.appendChild(tabulate(decodeAndClearString(stringPtr)));
        }
        refreshCollectionTable();

        sketchpadCollectButton.onclick = () => {
            let inputBytes = encodeStringAndCreateBytes(sketchpadInputTextarea.value);
            let success = lib.SoundPalette_midi_data_add_sysex(sketchpadCollectionMidiDataPtr, stringPtr, inputBytes.bytesPtr, inputBytes.bytesLen);
            lib.SoundPalette_bytes_free(inputBytes.bytesPtr, inputBytes.bytesLen);
            if (!success) {
                alert(decodeAndClearString(stringPtr));
            } else {
                refreshCollectionTable();
            }
        };

        let sketchpadCollectionClearButton = document.getElementById('sketchpad-collection-clear');
        sketchpadCollectionClearButton.disabled = false;
        sketchpadCollectionClearButton.onclick = () => {
            lib.SoundPalette_midi_data_clear_other_events(sketchpadCollectionMidiDataPtr);
            refreshCollectionTable();
        };

        let sketchpadCollectionExportButton = document.getElementById('sketchpad-collection-export')
        sketchpadCollectionExportButton.disabled = false;
        sketchpadCollectionExportButton.onclick = () => {
            let bytevecPtr = lib.SoundPalette_midi_data_write_midi(sketchpadCollectionMidiDataPtr);
            let bytesPtr = lib.SoundPalette_bytevec_ptr(bytevecPtr);
            let bytesLen = lib.SoundPalette_bytevec_len(bytevecPtr);
            let bytes = new Uint8Array(mem.buffer, bytesPtr, bytesLen);
            let blob = new Blob([bytes], { type: 'audio/midi' });
            lib.SoundPalette_bytevec_free(bytevecPtr);

            window.open(URL.createObjectURL(blob), '_blank');
        };

        // For now this is never freed, since the MIDI data is always in use.
        //lib.SoundPalette_midi_data_free(sketchpadCollectionMidiDataPtr);

        let webMIDIEnableButton = document.getElementById('webmidi-enable');
        webMIDIEnableButton.disabled = true;
        let webMIDIDevicesDropdown = document.getElementById('webmidi-devices');
        webMIDIDevicesDropdown.disabled = true;
        let webMIDIDevices = [];
        let webMIDIDeviceConnectButton = document.getElementById('webmidi-device-connect');
        let webMIDIOpenDevice = null;
        webMIDIDeviceConnectButton.disabled = true;
        let webMIDITestZone = document.getElementById('webmidi-test');
        webMIDITestZone.disabled = true;

        if (!navigator.requestMIDIAccess) {
            webMIDIEnableButton.textContent = '(Your browser does not support Web MIDI)';
        } else {
            webMIDIEnableButton.disabled = false;
            webMIDIEnableButton.onclick = () => {
                webMIDIEnableButton.textContent = '(Requesting permission)';
                webMIDIEnableButton.disabled = true;
                navigator.requestMIDIAccess({
                    sysex: true,
                    software: true,
                }).then((midiAccess) => {
                    webMIDIEnableButton.textContent = '(Web MIDI enabled)';
                    webMIDIDevicesDropdown.innerHTML = '';
                    let option = document.createElement('option');
                    option.value = '';
                    option.textContent = '(please select a device)';
                    webMIDIDevicesDropdown.appendChild(option);
                    webMIDIDevicesDropdown.required = true;
                    for (let device of midiAccess.outputs.values()) {
                        option = document.createElement('option');
                        option.value = webMIDIDevices.length;
                        option.textContent = device.name + ' (output)';
                        webMIDIDevicesDropdown.appendChild(option);
                        webMIDIDevices.push(device);
                    }
                    webMIDIDevicesDropdown.onchange = () => {
                        webMIDIDeviceConnectButton.disabled = (webMIDIDevicesDropdown.value === '');
                    };
                    webMIDIDevicesDropdown.disabled = false;
                    webMIDIDevicesDropdown.focus();
                }).catch((error) => {
                    webMIDIEnableButton.textContent = "(Can't enable Web MIDI)";
                    console.log(error);
                });
            };
            webMIDIDeviceConnectButton.onclick = () => {
                webMIDIDeviceConnectButton.disabled = true;
                webMIDIDevicesDropdown.disabled = true;
                webMIDITestZone.disabled = true;
                sketchpadSendButton.disabled = true;
                if (webMIDIOpenDevice) {
                    webMIDIDeviceConnectButton.textContent = '(disconnecting)';
                    webMIDIOpenDevice.close().then(() => {
                        webMIDIDeviceConnectButton.disabled = false;
                        webMIDIDeviceConnectButton.textContent = 'Connect';
                        webMIDIDevicesDropdown.disabled = false;
                    }).catch((e) => {
                        alert("Couldn't close MIDI device?! " + e);
                    });
                    webMIDIOpenDevice = null;
                } else {
                    webMIDIDeviceConnectButton.textContent = '(connecting)';
                    let newDevice = webMIDIDevices[webMIDIDevicesDropdown.value];
                    newDevice.open().then(() => {
                        webMIDIOpenDevice = newDevice;
                        webMIDIDeviceConnectButton.disabled = false;
                        webMIDIDeviceConnectButton.textContent = 'Disconnect';
                        webMIDITestZone.disabled = false;
                        sketchpadSendButton.disabled = false;
                    }).catch((e) => {
                        alert("Could not connect to MIDI device: " + e);
                        webMIDIDeviceConnectButton.disabled = false;
                        webMIDIDeviceConnectButton.textContent = 'Connect';
                        webMIDIDevicesDropdown.disabled = false;
                    });
                }
            };
        }

        let webMIDISentDataTextarea = document.getElementById('webmidi-sent-data');
        webMIDISentDataTextarea.disabled = true;

        let webMIDISentDataClearButton = document.getElementById('webmidi-sent-data-clear');
        webMIDISentDataClearButton.disabled = false;
        webMIDISentDataClearButton.onclick = () => {
            webMIDISentDataTextarea.textContent = '';
        };
        webMIDISentDataClearButton.onclick();

        function bytesToHex(midiBytes) {
            return Array.prototype.map.call(
                midiBytes,
                (byte) => (byte.toString(16).toUpperCase().padStart(2, '0') + 'h')
            ).join(' ');
        }
        function logText(text) {
            // If the user scrolled up, don't reset the scroll position when
            // logging new stuff.
            let wasScrolledToBottom = ((webMIDISentDataTextarea.scrollTop + webMIDISentDataTextarea.clientHeight) == webMIDISentDataTextarea.scrollHeight);
            webMIDISentDataTextarea.appendChild(document.createTextNode(text + '\n'));
            if (wasScrolledToBottom) {
                webMIDISentDataTextarea.scrollTop = webMIDISentDataTextarea.scrollHeight - webMIDISentDataTextarea.clientHeight;
            }
        }
        function logAndSend(midiBytes) {
            webMIDIOpenDevice.send(midiBytes);
            logText(bytesToHex(midiBytes));
        }

        let webMIDIChannelDropdown = document.getElementById('webmidi-channel');
        webMIDIChannelDropdown.innerHTML = '';
        for (let i = 0; i < 16; i++) {
            let option = document.createElement('option');
            option.textContent = i.toString(16).toUpperCase() + 'h — Channel #' + (i + 1) + ((i == 9) ? ' [GM: Percussion]' : '');
            option.value = i;
            webMIDIChannelDropdown.appendChild(option);
        }
        webMIDIChannelDropdown.value = 0;

        let webMIDIPCDropdown = document.getElementById('webmidi-pc');
        webMIDIPCDropdown.value = 0;

        let webMIDISendPCButton = document.getElementById('webmidi-send-pc');
        webMIDISendPCButton.onclick = () => {
            // These should already be in range, but just to be safe…
            let channel = (+webMIDIChannelDropdown.value) & 0xF;
            let program = (+webMIDIPCDropdown.value) & 0x7F;
            logAndSend([0xC0 | channel, program]);
        };

        let webMIDICCDropdown = document.getElementById('webmidi-cc');
        webMIDICCDropdown.value = 1;

        let webMIDICCValue0Dropdown = document.getElementById('webmidi-cc-value-0');
        webMIDICCValue0Dropdown.innerHTML = '';
        let webMIDICCValue1Dropdown = document.getElementById('webmidi-cc-value-1');
        webMIDICCValue1Dropdown.innerHTML = '';
        for (let j = 0; j < 2; j++) {
            for (let i = 0; i < 128; i++) {
                let option = document.createElement('option');
                option.textContent = i.toString(16).padStart(2, '0').toUpperCase() + 'h = ' + i;
                option.value = i;
                [webMIDICCValue0Dropdown, webMIDICCValue1Dropdown][j].appendChild(option);
            }
        }
        webMIDICCValue0Dropdown.value = 0;
        webMIDICCValue1Dropdown.value = 127;

        function makeCC(channel, control, value) {
            // These should already be in range, but just to be safe…
            channel = channel & 0xF;
            value = value & 0x7F;
            let data;
            if (control === -1) { // fake CC for Channel Pressure
                data = [0xD0 | channel, value];
            } else {
                control = control & 0x7F;
                data = [0xB0 | channel, control, value];
            }
            return data;
        }

        let webMIDISendCC0Button = document.getElementById('webmidi-send-cc-0');
        webMIDISendCC0Button.onclick = () => {
            let data = makeCC(+webMIDIChannelDropdown.value, +webMIDICCDropdown.value, +webMIDICCValue0Dropdown.value);
            logAndSend(data);
        };
        let webMIDISendCC1Button = document.getElementById('webmidi-send-cc-1');
        webMIDISendCC1Button.onclick = () => {
            let data = makeCC(+webMIDIChannelDropdown.value, +webMIDICCDropdown.value, +webMIDICCValue1Dropdown.value);
            logAndSend(data);
        };

        let webMIDISweepCC0To1 = document.getElementById('webmidi-sweep-cc-0-to-1');
        let webMIDISweepCC1To0 = document.getElementById('webmidi-sweep-cc-1-to-0');
        function sweepCC(channel, control, value0, value1, duration) {
            if (value0 === value1) {
                logAndSend(makeCC(channel, control, value0));
                return;
            }

            webMIDISweepCC0To1.disabled = true;
            webMIDISweepCC1To0.disabled = true;

            let minValue = Math.min(value0, value1);
            let maxValue = Math.max(value0, value1);
            for (let value = minValue; value <= maxValue; value += 1) {
                let t = ((value - value0) / (value1 - value0)) * duration;
                let data = makeCC(channel, control, value);
                webMIDIOpenDevice.send(data, performance.now() + t);
            }
            logText(bytesToHex(makeCC(channel, control, value0)) + ' → ' + bytesToHex(makeCC(channel, control, value1)));

            setTimeout(() => {
                webMIDISweepCC0To1.disabled = false;
                webMIDISweepCC1To0.disabled = false;
            }, duration);
        }
        webMIDISweepCC0To1.onclick = () => {
            sweepCC(+webMIDIChannelDropdown.value, +webMIDICCDropdown.value, +webMIDICCValue0Dropdown.value, +webMIDICCValue1Dropdown.value, 5000);
        };
        webMIDISweepCC1To0.onclick = () => {
            sweepCC(+webMIDIChannelDropdown.value, +webMIDICCDropdown.value, +webMIDICCValue1Dropdown.value, +webMIDICCValue0Dropdown.value, 5000);
        };

        let webMIDINoteDropdown = document.getElementById('webmidi-note');
        webMIDINoteDropdown.innerHTML = '';
        for (let i = 0; i < 128; i++) {
            let option = document.createElement('option');
            let relativeToC4 = i - 60;
            let note = ['C', 'C♯', 'D', 'D♯', 'E', 'F', 'F♯', 'G', 'G♯', 'A', 'A♯', 'B'][(relativeToC4 + 60) % 12];
            let octave = Math.floor(relativeToC4 / 12) + 4;

            let gm1Drums = [
                'Acoustic Bass Drum',
                'Bass Drum 1',
                'Side Stick',
                'Acoustic Snare',
                'Hand Clap',
                'Electric Snare',
                'Low Floor Tom',
                'Closed Hi Hat',
                'High Floor Tom',
                'Pedal Hi-Hat',
                'Low Tom',
                'Open Hi-Hat',
                'Low-Mid Tom',
                'Hi Mid Tom',
                'Crash Cymbal 1',
                'High Tom',
                'Ride Cymbal 1',
                'Chinese Cymbal',
                'Ride Bell',
                'Tambourine',
                'Splash Cymbal',
                'Cowbell',
                'Crash Cymbal 2',
                'Vibraslap',
                'Ride Cymbal 2',
                'Hi Bongo',
                'Low Bongo',
                'Mute Hi Conga',
                'Open Hi Conga',
                'Low Conga',
                'High Timbale',
                'Low Timbale',
                'High Agogo',
                'Low Agogo',
                'Cabasa',
                'Maracas',
                'Short Whistle',
                'Long Whistle',
                'Short Guiro',
                'Long Guiro',
                'Claves',
                'Hi Wood Block',
                'Low Wood Block',
                'Mute Cuica',
                'Open Cuica',
                'Mute Triangle',
                'Open Triangle',
            ];
            let gm1Drum = gm1Drums[i - 35] ? (' [GM1: ' + gm1Drums[i - 35] + ']') : '';

            option.textContent = i.toString(16).padStart(2, '0').toUpperCase() + 'h = ' + i + ' — ' + note + octave + gm1Drum;
            option.value = i;
            webMIDINoteDropdown.appendChild(option);
        }
        webMIDINoteDropdown.value = 69;

        let webMIDIVelocityDropdown = document.getElementById('webmidi-velocity');
        webMIDIVelocityDropdown.innerHTML = '';
        for (let i = 1; i < 128; i++) { // Don't allow “Note Off” velocity
            let option = document.createElement('option');
            option.textContent = i.toString(16).padStart(2, '0').toUpperCase() + 'h = ' + i;
            option.value = i;
            webMIDIVelocityDropdown.appendChild(option);
        }
        webMIDIVelocityDropdown.value = 100;

        let webMIDIDurationDropdown = document.getElementById('webmidi-duration');
        webMIDIDurationDropdown.innerHTML = '';
        for (let i = 0; i < 5; i++) {
            let option = document.createElement('option');
            option.textContent = '1⁄' + (2 ** i) + ' note in 4/4 time @ 120bpm';
            option.value = (60 / 120) * (4 / (2 ** i)) * 1000;
            webMIDIDurationDropdown.appendChild(option);
        }
        webMIDIDurationDropdown.value = 500;

        let webMIDIChordDropdown = document.getElementById('webmidi-chord');
        webMIDIChordDropdown.value = '0';

        function playNote(time) {
            webMIDIChordDropdown.value.split('-').forEach((offset) => {
                offset = +offset;
                // These should already be in range, but just to be safe…
                let channel = (+webMIDIChannelDropdown.value) & 0xF;
                let note = (+webMIDINoteDropdown.value + offset) & 0x7F;
                let velocity = (+webMIDIVelocityDropdown.value) & 0x7F;
                let duration = +webMIDIDurationDropdown.value;
                webMIDIOpenDevice.send([0x90 | channel, note, velocity], time);
                webMIDIOpenDevice.send([0x90 | channel, note, 0 /* Note Off */], time + duration);
            });
        }

        let webMIDIPlayNoteButton = document.getElementById('webmidi-play-note');
        webMIDIPlayNoteButton.onclick = () => {
            playNote(performance.now());
        };

        let webMIDINextRepeatedNote = null;
        function repeatNote() {
            if (webMIDINextRepeatedNote === null) {
                return;
            }
            playNote(webMIDINextRepeatedNote);
            // Schedule the next note based on when the current one should have
            // been, not when it actually was, in order to keep time.
            let interval = (+webMIDIDurationDropdown.value) * 2;
            webMIDINextRepeatedNote += Math.max(1.0, Math.ceil((performance.now() - webMIDINextRepeatedNote)/interval)) * interval;
            // Schedule next callback early so a bit of jitter there won't lead
            // to note being sent late, assuming the built-in scheduling for
            // MIDI works.
            setTimeout(repeatNote, (webMIDINextRepeatedNote - performance.now()) / 2);
        }

        let webMIDIRepeatNoteButton = document.getElementById('webmidi-repeat-note');
        webMIDIRepeatNoteButton.onclick = () => {
            if (webMIDINextRepeatedNote === null) {
                webMIDINextRepeatedNote = performance.now();
                repeatNote();
                webMIDIRepeatNoteButton.textContent = 'Stop repeat';
            } else {
                webMIDINextRepeatedNote = null
                webMIDIRepeatNoteButton.textContent = 'Repeat note';
            }
        };

        sketchpadSendButton.onclick = () => {
            let sysex = getSketchpadBytes(true);
            if (sysex === null) {
                return;
            }
            logAndSend(sysex);
        };
    }
}());
</script>

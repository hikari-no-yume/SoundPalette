<!doctype html>
<meta charset=utf-8>
<title>SoundPalette</title>

<style>
body {
    font-family: sans-serif;
}
h1 {
    margin: 0 0 0;
    font-weight: normal;
    font-style: italic;
    font-family: "MS PGothic", sans-serif;
    display: inline-block;
}
h1 > span:nth-child(1) {
    font-size: 1.5ex;
    text-transform: uppercase;
    color: chartreuse;
}
h1 > span:nth-child(2) {
    font-weight: bold;
    color: darkorange;
}
h1 > span:nth-child(3) {
    display: block;
    font-size: 40%;
    text-align: right;
    text-transform: uppercase;
}
#disclaimer {
    color: grey;
}
#log {
    max-width: 100%;
}
table, th, td {
    border: 1px solid gray;
    border-collapse: collapse;
}
th, td {
    vertical-align: top;
    text-align: left;
    font-family: monospace;
    padding: 0.25em;
}
#table-zone > table {
    width: 100%;
}
/* Show at most eight bytes per row for the raw event bytes column. */
#table-zone > table th:nth-child(2), #table-zone > table td:nth-child(2) {
    width: 32ch;
}
/* Try to match styling between button labels and other labels. */
button, label {
    font-size: smaller;
    font-family: -apple-system, sans-serif;
}
/* Prevent dropdowns from wrapping to a point left of the right edge of the
 * â€œGenerator SysEx:â€ label, and prevent them from shrinking the label.
 */
#sketchpad-generator {
    display: flex;
}
#sketchpad-generator > label {
    margin-right: 0.5em;
    padding-top: 0.1em;
    flex-shrink: 0;
}
</style>

<h1><span>Sound</span><span>Palette</span> <span>MIDI SysEx Generator</span></h1>
<p id=disclaimer>â€» SoundPalette is not a product of, affiliated with or endorsed by Roland Corporation.</p>

<noscript>SoundPalette is a SysEx editing tool. This is a web app that relies on WebAssembly and JavaScript. You appear to have these disabled, so you won't be able to use it.</noscript>

<fieldset>
<legend>Inspect Standard MIDI File</legend>
<input type=file id=file accept=audio/midi disabled autocomplete=off>
<br>
<textarea id=log disabled cols=80 rows=20 autocomplete=off>
This app is System Exclusive Parameter Editor.
Instruments do their best now and are preparing. Please watch warmly until it is ready.
The MIDI land was wrapped in Synthesis Magic. Girls believe that you solve this mysteryâ€¦
</textarea>
<div id=table-zone></div>
</fieldset>

<br>

<fieldset>
<legend>SysEx sketchpad</legend>
<div id=sketchpad-generator>
<label for=sketchpad-generator-root-dropdown>â†“ Generate SysEx:</label>
<div id=sketchpad-generator-dropdowns>
<select id=sketchpad-generator-root-dropdown required disabled>
<option value="">(please wait)</option>
</select><!-- avoid extra space between dropdowns --></div>
</div>
<textarea type=text id=sketchpad-input disabled cols=80 rows=5 autocomplete=off></textarea>
<br>
<button id=sketchpad-check disabled>â†“ Check</button>
<button id=sketchpad-copy disabled>ðŸ“„ Copy</button>
<button id=sketchpad-copy-no-suffix disabled>ðŸ“„ Copy (no h suffix)</button>
<br>
<textarea id=sketchpad-log disabled cols=80 rows=5 autocomplete=off>
This app is System Exclusive Parameter Editor.
Instruments do their best now and are preparing. Please watch warmly until it is ready.
The MIDI land was wrapped in Synthesis Magic. Girls believe that you solve this mysteryâ€¦
</textarea>
</fieldset>

<script>
(function () {
    'use strict';

    window.onload = function () {
        WebAssembly.instantiateStreaming(fetch('libSoundPalette.wasm'), {}).then(main);
    };

    let instance, lib, mem;

    function memcpy(destBuf, destPtr, srcBuf, srcPtr, size) {
        (new Uint8Array(destBuf, destPtr, size)).set(new Uint8Array(srcBuf, srcPtr, size))
    }

    function decodeAndClearString(stringPtr) {
        let bytesPtr = lib.SoundPalette_string_ptr(stringPtr);
        let bytesLen = lib.SoundPalette_string_len(stringPtr);

        let decoded = (new TextDecoder).decode(new Uint8Array(mem.buffer, bytesPtr, bytesLen));

        lib.SoundPalette_string_clear(stringPtr);

        return decoded;
    }

    function encodeStringAndCreateBytes(string) {
        let bytes = (new TextEncoder).encode(string);
        let bytesPtr = lib.SoundPalette_bytes_new(bytes.length);
        memcpy(mem.buffer, bytesPtr, bytes, 0, bytes.length);
        return {
            bytesPtr: bytesPtr,
            bytesLen: bytes.length, // needed for freeing
        };
    }

    // Parses the NullTerminatedStringTableStream format.
    function tabulate(string) {
        let pieces = string.split('\0');

        let table = document.createElement('table');
        let isHeaderRow = true;
        let tr = null;
        for (let i = 0; i < pieces.length; i++) {
            let piece = pieces[i];

            if (piece === '') {
                // '\0' is a terminator but String.prototype.split treats it as
                // a separator, so there's a phantom row at the end.
                if (tr === null && i === pieces.length - 1) {
                    break;
                }

                table.appendChild(tr);
                tr = null;
                isHeaderRow = false;
                continue;
            }

            if (tr === null) {
                tr = document.createElement('tr');
            }

            let td = document.createElement(isHeaderRow ? 'th' : 'td');
            td.textContent = piece;
            tr.appendChild(td);
        }

        if (tr !== null) {
            table.appendChild(tr);
        }

        return table;
    }

    function main(result) {
        instance = result.instance;
        lib = instance.exports;
        mem = instance.exports.memory;

        let fileInput = document.getElementById('file');
        fileInput.disabled = false;
        fileInput.value = ''; // clear any cached value
        let logTextarea = document.getElementById('log');
        logTextarea.textContent = 'SoundPalette system ready. Please load a file.';

        let tableZone = document.getElementById('table-zone');

        let stringPtr = lib.SoundPalette_string_new(0);

        fileInput.onchange = () => {
            fileInput.files[0].arrayBuffer().then((buffer) => {
                let bufferU8 = new Uint8Array(buffer);

                let destBytesLen = bufferU8.length;
                let destBytesPtr = lib.SoundPalette_bytes_new(destBytesLen);
                memcpy(mem.buffer, destBytesPtr, buffer, 0, destBytesLen);
                let midiDataPtr = lib.SoundPalette_read_midi_and_log(stringPtr, destBytesPtr, destBytesLen);
                lib.SoundPalette_bytes_free(destBytesPtr, destBytesLen);

                logTextarea.textContent = decodeAndClearString(stringPtr);

                if (midiDataPtr === 0) {
                    return;
                }

                lib.SoundPalette_midi_data_list_other_events(stringPtr, midiDataPtr);

                tableZone.innerHTML = '';
                tableZone.appendChild(tabulate(decodeAndClearString(stringPtr)));

                lib.SoundPalette_midi_data_free(midiDataPtr);
            });
        };

        let sketchpadInputTextarea = document.getElementById('sketchpad-input');
        sketchpadInputTextarea.disabled = false;
        let sketchpadLogTextarea = document.getElementById('sketchpad-log');
        sketchpadLogTextarea.textContent = 'SoundPalette system ready. Please enter a SysEx.';

        let sketchpadCheckButton = document.getElementById('sketchpad-check');
        sketchpadCheckButton.disabled = false;
        sketchpadCheckButton.onclick = () => {
            let inputBytes = encodeStringAndCreateBytes(sketchpadInputTextarea.value);
            lib.SoundPalette_check_sysex(stringPtr, inputBytes.bytesPtr, inputBytes.bytesLen);
            lib.SoundPalette_bytes_free(inputBytes.bytesPtr, inputBytes.bytesLen);

            sketchpadLogTextarea.textContent = decodeAndClearString(stringPtr);
        };

        function doCopy() {
            sketchpadInputTextarea.select();
            // I don't trust this fancy new tech!
            if (navigator.clipboard) {
                navigator.clipboard.writeText(sketchpadInputTextarea.value);
            } else {
                document.execCommand('copy');
            }
        }

        let sketchpadCopyButton = document.getElementById('sketchpad-copy');
        sketchpadCopyButton.disabled = false;
        sketchpadCopyButton.onclick = () => {
            doCopy();
        };

        let sketchpadCopyNoSuffixButton = document.getElementById('sketchpad-copy-no-suffix');
        sketchpadCopyNoSuffixButton.disabled = false;
        sketchpadCopyNoSuffixButton.onclick = () => {
            // This should be kept in sync with the Rust sysex parsing.
            let unsuffixed = sketchpadInputTextarea
                .value
                .split(/\s+/)
                .map(hex =>
                    ((hex.endsWith('h') || hex.endsWith('H'))
                    ? hex.substring(0, hex.length - 1)
                    : hex))
                .join(' ');
            sketchpadInputTextarea.value = unsuffixed;
            doCopy();
        };

        let sketchpadGeneratorDropdownsZone = document.getElementById('sketchpad-generator-dropdowns');

        let menuStackDropdowns = [document.getElementById('sketchpad-generator-root-dropdown')];
        let menuStackPtr = lib.SoundPalette_sysex_generator_menu_stack_new();

        function menuStackUpdateCurrentList() {
            lib.SoundPalette_sysex_generator_menu_stack_list_items(stringPtr, menuStackPtr);
            let menuItems = decodeAndClearString(stringPtr).split('\0');
            if (menuItems[0] === '' && menuItems.length === 1) { // empty menu
                menuItems = [];
            }

            let menuStackDropdown = menuStackDropdowns[menuStackDropdowns.length - 1];
            menuStackDropdown.innerHTML = '';
            let unselectedOption = document.createElement('option');
            unselectedOption.textContent = '(please select)';
            unselectedOption.value = '';
            menuStackDropdown.appendChild(unselectedOption);
            let stackHeightForDropdown = menuStackDropdowns.length;
            menuItems.forEach((item, itemIdx) => {
                let option = document.createElement('option');
                option.textContent = item;
                option.value = itemIdx;
                menuStackDropdown.appendChild(option);
            });
            menuStackDropdown.onchange = () => {
                let selectedIdx = menuStackDropdown.value;
                if (selectedIdx === '') {
                    menuStackPush(stackHeightForDropdown, null);
                } else {
                    menuStackPush(stackHeightForDropdown, +selectedIdx);
                }
            };
            menuStackDropdown.disabled = false;
        }

        function menuStackPush(stackHeightForDropdown, itemIdx) {
            console.log('Push at: ' + stackHeightForDropdown);

            // Only the top item of the stack can be manipulated at once.
            // If the menu that the selection was made in is not the top one,
            // the menus above it need to be popped.
            while (stackHeightForDropdown < menuStackDropdowns.length) {
                console.log('- Popping: ' + menuStackDropdowns.length);
                lib.SoundPalette_sysex_generator_menu_stack_pop(menuStackPtr);

                let oldDropdown = menuStackDropdowns.pop();
                oldDropdown.parentElement.removeChild(oldDropdown);
            }

            if (itemIdx === null) {
                console.log('- No descent.');
                return;
            }

            console.log('- Descending: ' + itemIdx);
            let didGenerateSysEx = lib.SoundPalette_sysex_generator_menu_stack_push(stringPtr, menuStackPtr, itemIdx);
            if (didGenerateSysEx) {
                console.log('- SysEx generated.');
                sketchpadInputTextarea.value = decodeAndClearString(stringPtr);
            } else {
                console.log('- New submenu.');
                let newDropdown = document.createElement('select');
                newDropdown.required = true;
                newDropdown.disabled = true;
                sketchpadGeneratorDropdownsZone.appendChild(newDropdown);
                menuStackDropdowns.push(newDropdown);

                menuStackUpdateCurrentList();

                newDropdown.focus();
            }
        }

        menuStackUpdateCurrentList();

        // For now this is never freed, since the menu stack is always in use.
        //lib.SoundPalette_sysex_generator_menu_stack_free(menuStackPtr);
    }
}());
</script>

<!doctype html>
<meta charset=utf-8>
<title>SoundPalette</title>

<style>
body {
    font-family: sans-serif;
}
#log {
    max-width: 100%;
}
table, th, td {
    border: 1px solid gray;
    border-collapse: collapse;
}
th, td {
    vertical-align: top;
    text-align: left;
    font-family: monospace;
    padding: 0.25em;
}
#table-zone > table {
    width: 100%;
}
/* Show at most eight bytes per row for the raw event bytes column. */
#table-zone > table th:nth-child(2), #table-zone > table td:nth-child(2) {
    width: 32ch;
}
</style>

<noscript>SoundPalette is a SysEx editing tool. This is a web app that relies on WebAssembly and JavaScript. You appear to have these disabled, so you won't be able to use it.</noscript>

<input type=file id=file accept=audio/midi disabled autocomplete=off>
<br>
<textarea id=log disabled cols=80 rows=20 autocomplete=off>
This app is System Exclusive Parameter Editor.
Instruments do their best now and are preparing. Please watch warmly until it is ready.
The MIDI land was wrapped in Synthesis Magic. Girls believe that you solve this mysteryâ€¦
</textarea>
<div id=table-zone></div>

<script>
(function () {
    'use strict';

    window.onload = function () {
        WebAssembly.instantiateStreaming(fetch('libSoundPalette.wasm'), {}).then(main);
    };

    let instance, lib, mem;

    function memcpy(destBuf, destPtr, srcBuf, srcPtr, size) {
        (new Uint8Array(destBuf, destPtr, size)).set(new Uint8Array(srcBuf, srcPtr, size))
    }

    function decodeAndClearString(stringPtr) {
        let bytesPtr = lib.SoundPalette_string_ptr(stringPtr);
        let bytesLen = lib.SoundPalette_string_len(stringPtr);

        let decoded = (new TextDecoder).decode(new Uint8Array(mem.buffer, bytesPtr, bytesLen));

        lib.SoundPalette_string_clear(stringPtr);

        return decoded;
    }

    // Parses the NullTerminatedStringTableStream format.
    function tabulate(string) {
        let pieces = string.split('\0');

        let table = document.createElement('table');
        let isHeaderRow = true;
        let tr = null;
        for (let i = 0; i < pieces.length; i++) {
            let piece = pieces[i];

            if (piece === '') {
                // '\0' is a terminator but String.prototype.split treats it as
                // a separator, so there's a phantom row at the end.
                if (tr === null && i === pieces.length - 1) {
                    break;
                }

                table.appendChild(tr);
                tr = null;
                isHeaderRow = false;
                continue;
            }

            if (tr === null) {
                tr = document.createElement('tr');
            }

            let td = document.createElement(isHeaderRow ? 'th' : 'td');
            td.textContent = piece;
            tr.appendChild(td);
        }

        if (tr !== null) {
            table.appendChild(tr);
        }

        return table;
    }

    function main(result) {
        instance = result.instance;
        lib = instance.exports;
        mem = instance.exports.memory;

        let fileInput = document.getElementById('file');
        fileInput.disabled = false;
        fileInput.value = ''; // clear any cached value
        let logTextarea = document.getElementById('log');
        logTextarea.textContent = 'SoundPalette system ready. Please load a file.';

        let tableZone = document.getElementById('table-zone');

        let stringPtr = lib.SoundPalette_string_new(0);

        fileInput.onchange = () => {
            fileInput.files[0].arrayBuffer().then((buffer) => {
                let bufferU8 = new Uint8Array(buffer);

                let destBytesLen = bufferU8.length;
                let destBytesPtr = lib.SoundPalette_bytes_new(destBytesLen);
                memcpy(mem.buffer, destBytesPtr, buffer, 0, destBytesLen);
                let midiDataPtr = lib.SoundPalette_read_midi_and_log(stringPtr, destBytesPtr, destBytesLen);
                lib.SoundPalette_bytes_free(destBytesPtr, destBytesLen);

                logTextarea.textContent = decodeAndClearString(stringPtr);

                if (midiDataPtr === 0) {
                    return;
                }

                lib.SoundPalette_midi_data_list_other_events(stringPtr, midiDataPtr);

                tableZone.innerHTML = '';
                tableZone.appendChild(tabulate(decodeAndClearString(stringPtr)));

                lib.SoundPalette_midi_data_free(midiDataPtr);
            });
        };
    }
}());
</script>
